{% load static %}
<html>
    <head>
        <title>CardGame28</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <style> 
            body {
                margin: 0;
            }
            #game_room {
                position: absolute;
                left: 0%;
                top:  0%;
                width: 100%;
                height: 100%;
                z-index: 5;
            }
            #game_table {
                border: 2px solid #8b2;
                border-radius: 30px;
                position: absolute;
                left: 10%;
                top:  10%;
                width: 80%;
                height: 80%;
                z-index: 10;
            }
            #game_controls {
                background-color: darkgray; 
                padding: 5%;
                position: absolute;
                left: 0%;
                top: 55%;
                width: 89.9%;
                height: 25%;
                overflow-x: hidden;
                overflow-y: auto; 
                z-index: 15;
            }
            .player {
                background-color: darkgray; 
                position: absolute;
                width: 15%;
                height: 10%;
                z-index: 25;
            }
            .player_photo {
                border-radius: 50%;
                position: absolute;
                width: 100%;
                height: 100%
            }
            .player_text {
                position: absolute;
                left: 0%;
                top: 80%;
                width: 100%;
                text-align: center;
            }
            #player_1 {
                left: 43%;
                top: 2%;
            }
            #player_2 {
                left: 85%;
                top: 15%;
            }
            #player_3 {
                left: 85%;
                top: 40%;
            }
            #player_5 {
                left: 0%;
                top: 40%;
            }
            #player_6 {
                left: 0%;
                top: 15%;
            }
            #player_2_four {
                left: 85%;
                top: 30%;
            }
            #player_6_four {
                left: 0%;
                top: 30%;
            }
            .card_holder {
                background-color: red;
                position: absolute;
                width: 45px;
                height: 60px;
            }
            .playing_card_heads {
                width: 45px;
                height: 60px;
            }
            .playing_card_sides {
                width: 100%;
                height: 100%;
                transform: rotate(90deg);
            }
            .playing_card_top_right {
                width: 100%;
                height: 100%;
                transform: rotate(60deg);
            }
            .playing_card_bottom_right {
                width: 100%;
                height: 100%;
                transform: rotate(120deg);
            }
            .playing_card_bottom_left {
                width: 100%;
                height: 100%;
                transform: rotate(240deg);
            }
            .playing_card_top_left {
                width: 100%;
                height: 100%;
                transform: rotate(300deg);
            }
            #player_1_card {
                position: absolute;
                left: 45%;
                top: 5%;
            }
            #player_2_card {
                position: absolute;
                left: 65%;
                top: 15%;
            }
            #player_3_card {
                position: absolute;
                left: 65%;
                top: 30%;
            }
            #player_4_card {
                position: absolute;
                left: 45%;
                top: 40%;
            }
            #player_5_card {
                position: absolute;
                left: 25%;
                top: 30%;
            }
            #player_6_card {
                position: absolute;
                left: 25%;
                top: 15%;
            }
            #trump_card {
                position: absolute;
                left: 7%;
                top: 87%;
            }
            #my_cards {
                background-color: blue;
                position: absolute;
                left: 35%;
                top: 83%;
                width: 50%;
                height: 10%;
                z-index: 25;
            }
            .my_card_holder {
                background-color: yellow;
                position: absolute;
                top: 20%;
            }
            #my_drag_card {
                position: absolute;
                left:0%;
                border: 2px solid red;
                visibility: hidden;
                position: absolute;
                width: 20%;
                height: 80%;
                top: 0%;
                z-index: 10;
            }
            .my_card_1 {
                position: absolute;
                left: 5%;
                z-index: 1;
            }
            .my_card_2 {
                position: absolute;
                left: 15%;
                z-index: 2;
            }
            .my_card_3 {
                position: absolute;
                left: 25%;
                z-index: 3;
            }
            .my_card_4 {
                position: absolute;
                left: 35%;
                z-index: 4;
            }
            .my_card_5 {
                position: absolute;
                left: 45%;
                z-index: 5;
            }
            .my_card_6 {
                position: absolute;
                left: 55%;
                z-index: 6;
            }
            .my_card_7 {
                position: absolute;
                left: 65%;
                z-index: 7;
            }
            .my_card_8 {
                position: absolute;
                left: 75%;
                z-index: 8;
            }
            .card_template {
                visibility: hidden;
                position: absolute;
                left: 5%;
                z-index: 1;
            }
            .card_carrier {
                z-index: 20;
            }
            .drop_card_anim {
                animation-duration: 400ms;
                animation-name: drop_card_anim;
                animation-iteration-count: 1;
            }
            @keyframes drop_card_anim {
                /* from {
                    left: 45%;
                    top: 83%;
                } */
                to {
                    left: 45%;
                    top: 40%; 
                }
            }
            </style>
            <script type="text/javascript">
                selectedCard = null;
                
                function intializePage() {
                    addNewCards("");
                    /*var my_cards = document.getElementById("my_cards"); 
                    my_cards.addEventListener("touchstart", dragMyCard, false);
                    my_cards.addEventListener("touchend", dropMyCard, false);
                    */
                }
                dragStart = 0;
                
                function selectMyCard(card) {
                    card.style.top = "0%";
                    dragCard = document.getElementById("my_drag_card");
                    dragCardShow = "hidden";
                    
                    if (selectedCard != null)
                        selectedCard.style.top = "20%";
                    if (selectedCard == card)
                        selectedCard = null;
                    else {
                        selectedCard = card;
                        dragCardShow = "visible";
                        dragCard.style.left = selectedCard.style.left;
                    }
                    dragCard.style.visibility = dragCardShow;
                }
                
                function dragMyCard(event) {
                    event.dataTransfer.setData("Text", event.target.id);
                }
                
                function dropMyCard(event) {
                    allowDrop(event);
                    if (selectedCard == null)
                        return;
                    newNeighborCard = event.target.parentElement;
                     
                    newPos = parseInt(newNeighborCard.style.left.replace("%", ""));
                    oldPos = parseInt(selectedCard.style.left.replace("%", ""));
                    newzIndex = newNeighborCard.style.zIndex;
                    oldzIndex = selectedCard.style.zIndex;
                    
                    moveDirection = 1; //1 for left, -1 for right
                    if (newzIndex > oldzIndex)
                        moveDirection = -1;
                    
                    cardShiftPos = ((newPos - oldPos)/ (newzIndex - oldzIndex)) * moveDirection;
                                        
                    var children = newNeighborCard.parentElement.children;
                    for (var i = 0; i < children.length; i++) {
                      var card = children[i];
                      if (card.id == "my_drag_card")
                        continue;
                      if ((card.style.zIndex >= newzIndex && card.style.zIndex < oldzIndex) || (card.style.zIndex <= newzIndex && card.style.zIndex > oldzIndex)) {
                        card.style.left = (parseInt(card.style.left.replace("%", "")) + cardShiftPos) + "%";
                        card.style.zIndex = parseInt(card.style.zIndex) + moveDirection;
                      }
                    }
                    selectedCard.style.left = newPos + "%";
                    selectedCard.style.zIndex = newzIndex;
                    dragCard = document.getElementById("my_drag_card");
                    dragCard.style.left = newPos + "%";
                }
                
                function allowDrop(event) {
                    event.preventDefault();
                }
                
                function addNewCards(cards) {
                    myCards = document.getElementById("my_cards");
                    cardCount = myCards.children.length - 1;
                    //newCardHtml = '<div id="my_card_1" class="my_card_holder my_card_1" onclick="selectMyCard(this)" ondblclick="" ondrop="dropMyCard(event, this)" ondragover="allowDrop(event)"></div>';
                
                    //newCard = document.createElement(newCardHtml);
                    newCard = document.getElementById("card_CA").cloneNode(true);
                    newCard.id = "card_1"
                    newCard.style.left = "5%";
                    newCard.style.zIndex = "1";
                    newCard.style.visibility = "visible";
                    myCards.appendChild(newCard);
                    
                    newCard = document.getElementById("card_BK").cloneNode(true);
                    newCard.id = "card_2"
                    newCard.style.left = "15%";
                    newCard.style.zIndex = "2";
                    newCard.style.visibility = "visible";
                    myCards.appendChild(newCard);
                    
                    newCard = document.getElementById("card_BK").cloneNode(true);
                    newCard.id = "card_3"
                    newCard.style.left = "25%";
                    newCard.style.zIndex = "3";
                    newCard.style.visibility = "visible";
                    myCards.appendChild(newCard);
                    
                    newCard = document.getElementById("card_BK").cloneNode(true);
                    newCard.id = "card_4"
                    newCard.style.left = "35%";
                    newCard.style.zIndex = "4";
                    newCard.style.visibility = "visible";
                    myCards.appendChild(newCard);
                    
                    newCard = document.getElementById("card_CA").cloneNode(true);
                    newCard.id = "card_5"
                    newCard.style.left = "45%";
                    newCard.style.zIndex = "5";
                    newCard.style.visibility = "visible";
                    myCards.appendChild(newCard);
                    
                    newCard = document.getElementById("card_BK").cloneNode(true);
                    newCard.id = "card_6"
                    newCard.style.left = "55%";
                    newCard.style.zIndex = "6";
                    newCard.style.visibility = "visible";
                    myCards.appendChild(newCard);
                    
                    newCard = document.getElementById("card_CA").cloneNode(true);
                    newCard.id = "card_7"
                    newCard.style.left = "65%";
                    newCard.style.zIndex = "7";
                    newCard.style.visibility = "visible";
                    myCards.appendChild(newCard);
                    
                    newCard = document.getElementById("card_BK").cloneNode(true);
                    newCard.id = "card_8"
                    newCard.style.left = "75%";
                    newCard.style.zIndex = "8";
                    newCard.style.visibility = "visible";
                    myCards.appendChild(newCard);
                }
                
                var dragCardClickTimeoutId = null;
                function dragCardClick(event) {
                    if (selectedCard == null)
                        return;
                    if (event.type == "dblclick") {
                        window.clearTimeout(dragCardClickTimeoutId);
                        dragCardClickTimeoutId = null;
                        putMyCard(selectedCard);
                    }
                    else if (event.type == "click" && dragCardClickTimeoutId == null)
                        dragCardClickTimeoutId = setTimeout("selectMyCard(selectedCard); dragCardClickTimeoutId = null;", 500);
                        
                    //document.getElementById("game_controls").innerHTML += event.type + "\n";
                }
                
                function putMyCard(card) {
                    // player4Card = document.getElementById("player_4_card");
                    //cardImg = player4Card.getElementById("card_img");
                    
                    // player4Card.removeChild(player4Card.children[0]);
                    // player4Card.appendChild(card);
                    cardCarrier_1 = document.getElementById("card_carrier_1");
                    cardCarrier_1.innerHTML = "";
                    cardCarrier_1.appendChild(card.children[0])
                    cardPos = card.getBoundingClientRect()
                    cardCarrier_1.style.top = cardPos.top + "px"
                    cardCarrier_1.style.left = cardPos.left + "px"
                    card.parentElement.removeChild(card)
                    
                    cardCarrier_1.addEventListener("animationstart", listener_animation, false);
                    cardCarrier_1.addEventListener("animationend", listener_animation, false);



                    cardCarrier_1.classList.toggle("drop_card_anim");
                }

                function listener_animation(event) {
                    switch(event.type) {
                        case "animationstart":
                            break
                        case "animationend":
                            player4Card = document.getElementById("player_4_card");
                            player4Card.innerHTML = "";
                            player4Card.appendChild(event.target.children[0]);

                            cardCarrier_1 = document.getElementById("card_carrier_1");
                            cardCarrier_1.classList.toggle("drop_card_anim");
                        break;
                    }
                }
                //---------------------------------------------------------------------------------

                sendChatMsg = new XMLHttpRequest(); 
                getNewMsg = new XMLHttpRequest(); 
                var gameSocket = new WebSocket("ws://ec2-3-134-97-118.us-east-2.compute.amazonaws.com:8000")
                gameSocket.onmessage = function (event) {
                    onMessageRecievedSuccess(event.data);
                }

                function sendChatMessage() { 
                    chat_msg = document.getElementById("chat_input").value;
                    gameSocket.send(chat_msg);
                    document.getElementById("chat_input").value = "";
                }
                              
                function onMessageRecievedSuccess(data) {
                    newMsg = "<span style='color:blue'>Game28:</span> <span style='color:black'>" + data  + "</span><br>" 
                    document.getElementById("new_messages").innerHTML += newMsg;
                }
            </script>
    </head>
    <body oncontextmenu="return false;" onload="intializePage()">
        <div id="game_room">
            <div id="player_1" class="player">
                <img id="player_img" class="player_photo" src="{% static "media/anonymous.jpg" %}" alt="Player 1">
                <div id="player_name" class="player_text">Player 1</div>
            </div>
            <div id="player_2" class="player">
                <img id="player_img" class="player_photo" src="{% static "media/anonymous.jpg" %}" alt="Player 2">
                <div id="player_name" class="player_text">Player 2</div>
            </div>
            <div id="player_3" class="player">
                <img id="player_img" class="player_photo" src="{% static "media/anonymous.jpg" %}" alt="Player 3">
                <div id="player_name" class="player_text">Player 3</div>
            </div>
            <div id="player_5" class="player">
                <img id="player_img" class="player_photo" src="{% static "media/anonymous.jpg" %}" alt="Player 5">
                <div id="player_name" class="player_text">Player 5</div>
            </div>
            <div id="player_6" class="player">
                <img id="player_img" class="player_photo" src="{% static "media/anonymous.jpg" %}" alt="Player 6">
                <div id="player_name" class="player_text">Player 6</div>
            </div>
            <div id="game_table">
                <div id="player_1_card" class="card_holder">
                    <img id="card_img" class="playing_card_heads" src="{% static "media/playing_card_back.jpg" %}">
                </div>
                <div id="player_2_card" class="card_holder">
                    <img id="card_img" class="playing_card_top_right" src="{% static "media/playing_card_back.jpg" %}">
                </div>
                <div id="player_3_card" class="card_holder">
                    <img id="card_img" class="playing_card_bottom_right" src="{% static "media/playing_card_back.jpg" %}">
                </div>
                <div id="player_4_card" class="card_holder">
                    <img id="card_img" class="playing_card_heads" src="{% static "media/playing_card_back.jpg" %}">
                </div>
                <div id="player_5_card" class="card_holder">
                    <img id="card_img" class="playing_card_bottom_left" src="{% static "media/playing_card_back.jpg" %}">
                </div>
                <div id="player_6_card" class="card_holder">
                    <img id="card_img" class="playing_card_top_left" src="{% static "media/playing_card_back.jpg" %}">
                </div>
                <div id="trump_card" class="card_holder">
                    <img id="card_img" class="playing_card_heads" src="{% static "media/playing_card_back.jpg" %}">
                </div>
                <div id="game_controls">
                    <div class="new_msg" id="new_messages">
                        <span style="color:blue">Game28:</span> <span style="color:gray">Waiting for other player to join...</span><br>
                    </div><br>
                    <div>
                        <form onsubmit="sendChatMessage(); return false;">
                            <input type="text" id="chat_input"> 
                            <input type="submit" value="Send">
                        </form>    
                    </div>
                </div>                
            </div>

            <div id="my_cards">
                <div id="my_drag_card" draggable="true" onclick="dragCardClick(event)" ondblclick="dragCardClick(event)" ondragstart="dragMyCard(event)">
                </div>
            </div>
            <div id="card_BK" class="card_holder my_card_holder card_template" onclick="selectMyCard(this)" ondrop="dropMyCard(event)" ondragover="allowDrop(event)">
                <img id="card_img" class="playing_card_heads" src="{% static "media/playing_card_back.jpg" %}">
            </div>
            <div id="card_CA" class="card_holder my_card_holder card_template" onclick="selectMyCard(this)" ondrop="dropMyCard(event)" ondragover="allowDrop(event)">
                <img id="card_img" class="playing_card_heads" src="{% static "media/CA.png" %}">
            </div>
            <div id="card_carrier_1" class="card_holder card_carrier">

            </div>
        </div>
    </body>
</html>

